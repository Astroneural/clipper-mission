<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Spacecraft Game with Geysers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #collisionCounter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
        }
        #infoText {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
        }
        /* Added Planet Info Text */
        #infoTextPlanet {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
        }
        #cameraLockButton {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
        }
        #cameraLockButton:hover {
            background: rgba(50, 50, 50, 0.7);
        }
        #cameraLockButton_planet {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
        }
        #cameraLockButton_planet:hover {
            background: rgba(50, 50, 50, 0.7);
        }
    </style>
</head>
<body>
    <div id="collisionCounter">Geyser Collisions: 0</div>
    <div id="infoText">Europa clipper was launched in Oct. 2024 with the mission to learn more about Europa. Because of its liquid ocean underneath the ice, is one of the best possibilities for life outside Earth in our Solar System. One of the nine instruments on board, MASPEX, collects gas from Europa's atmosphere to determine its makeup. Some gas does come from the geysers on Europa spewing water vapor, but a few : <ul><li>Clipper does not actually fly through the plumes</li><li>Clipper does not orbit Europa, but instead Jupiter, and will make 44 flybys.</li></div>
    <div id="infoTextPlanet">Europa is one of the many moons of Jupiter and one of only two icy moons in the Solar System, the other being Saturn's moon Enceladus. Beneath the ice layer lies a liquid ocean (twice the size of all of Earth's!) thanks to the gravitational effects of Jupiter. Europa also has geysers erupting water vapor which may hint at inner contents and the possibility of life. On the surface, we can also see cracks along the surface. These, along with the lack of craters and the fact that it is the smoothest object in the solar system, suggest the surface is self-healing.</div>
    <button id="cameraLockButton">More on Europa Clipper</button>
    <button id="cameraLockButton_planet">More on Europa</button>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Load background texture
        const loader = new THREE.TextureLoader();
        loader.load('models/pexels-free-nature-stock-7480.jpg', function(texture) {
                scene.background = texture;
        });

        // Camera lock state
        let cameraLockedToSpacecraft = false;
        let cameraLockedToPlanet = false;
        const cameraLockButton = document.getElementById('cameraLockButton');
        const cameraLockButton_planet = document.getElementById('cameraLockButton_planet');

        cameraLockButton.addEventListener('click', () => {
            cameraLockedToSpacecraft = !cameraLockedToSpacecraft;
            if (cameraLockedToSpacecraft) {
                cameraLockedToPlanet = false;
                cameraLockButton_planet.textContent = "Lock Camera to Planet";
            }
            cameraLockButton.textContent = cameraLockedToSpacecraft ? 
            "Unlock Camera" : "Lock Camera to Spacecraft";
        });

        cameraLockButton_planet.addEventListener('click', () => {
            cameraLockedToPlanet = !cameraLockedToPlanet;
            if (cameraLockedToPlanet) {
                cameraLockedToSpacecraft = false;
                cameraLockButton.textContent = "Lock Camera to Spacecraft";
            }
            cameraLockButton_planet.textContent = cameraLockedToPlanet ? 
            "Unlock Camera" : "Lock Camera to Planet";
        });

        const ambientLight = new THREE.AmbientLight(0xffffff, 2);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 4);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // Create a planet group to contain both the planet model and geysers
        const planetGroup = new THREE.Group();
        scene.add(planetGroup);

        // Load Planet from GLB
        let planet;
        const gltfLoader = new THREE.GLTFLoader();
        gltfLoader.load('models/Europa_1_3138_2.glb', function(gltf) {
            planet = gltf.scene;
            planet.scale.set(.01, .01, .01);
            planet.position.set(0, 0, 0);
            planet.traverse(function(child) {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        color: 0xffffff,
                        roughness: 1,
                        metalness: 1,
                        map: child.material.map,
                        normalMap: child.material.normalMap
                    });
                }
            });
            planetGroup.add(planet);
        }, undefined, function(error) {
            console.error(error);
        });

        // Spacecraft
        let spacecraft;
        gltfLoader.load('models/clipper_spacecraft.glb', function(gltf) {
            spacecraft = gltf.scene;
            spacecraft.scale.set(0.15, 0.15, 0.15);
            spacecraft.position.set(8, 0, 0); // Start in orbit
            spacecraft.traverse(function(child) {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        color: child.material.color || 0xffffff,
                        roughness: 0.5,
                        metalness: 1,
                        map: child.material.map,
                        normalMap: child.material.normalMap
                    });
                }
            });
            scene.add(spacecraft);
        }, undefined, function(error) {
            console.error(error);
        });

        camera.position.set(0, 15, 20);
        camera.lookAt(new THREE.Vector3(0, 0, 0));

        // Gravity
        let velocity = new THREE.Vector3(0, 0.5, 0);
        const gravityStrength = 0.01;
        const rotationSpeed = 0.005;

        function checkCollision() {
            const distance = spacecraft.position.length();
            if (distance < 5.5) {
                alert("Game Over: Spacecraft crashed into the planet!");
                spacecraft.position.set(8, 0, 0);
                velocity.set(0, 0.5, 0);
            }
        }

        // Geyser Particles
        const geyserParticles = [];
        let geyserCollisionCount = 0;
        const collisionCounterDiv = document.getElementById("collisionCounter");

        function randomPointOnSphere(radius) {
            const u = Math.random();
            const v = Math.random();
            const theta = 2 * Math.PI * u;
            const phi = Math.acos(2 * v - 1);
            const x = radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.sin(phi) * Math.sin(theta);
            const z = radius * Math.cos(phi);
            return new THREE.Vector3(x, y, z);
        }

        function createGeyserParticle(surfacePoint) {
            const particleCount = 100;
            const geyserGroup = new THREE.Group();
            geyserGroup.position.copy(surfacePoint);
            planetGroup.add(geyserGroup);
            for (let i = 0; i < particleCount; i++) {
                const coneGeometry = new THREE.ConeGeometry(0.05, 0.125, 8);
                const coneMaterial = new THREE.MeshBasicMaterial({ color: 0x99ccff });
                const cone = new THREE.Mesh(coneGeometry, coneMaterial);
                const offset = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.1,
                    (Math.random() - 0.5) * 0.1,
                    (Math.random() - 0.5) * 0.1
                );
                cone.position.copy(offset);
                cone.lookAt(offset.clone().add(surfacePoint.clone().normalize()));
                const speed = 0.15 + Math.random() * 0.1;
                const directionVariation = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.1,
                    (Math.random() - 0.5) * 0.1,
                    (Math.random() - 0.5) * 0.1
                );
                const direction = surfacePoint.clone().normalize().add(directionVariation).normalize();
                const particleVelocity = direction.multiplyScalar(speed);
                const lifetime = 100;
                geyserParticles.push({ 
                    mesh: cone, 
                    velocity: particleVelocity, 
                    lifetime: lifetime,
                    geyserGroup: geyserGroup
                });
                geyserGroup.add(cone);
            }
        }

        // Track geyser warnings
        const upcomingGeysers = [];
        const clock = new THREE.Clock();

        function scheduleGeyser() {
            const surfacePoint = randomPointOnSphere(5);
            const markerGeometry = new THREE.SphereGeometry(0.2, 8, 8);
            const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const markerMesh = new THREE.Mesh(markerGeometry, markerMaterial);
            markerMesh.position.copy(surfacePoint);
            planetGroup.add(markerMesh);
            upcomingGeysers.push({ marker: markerMesh, surfacePoint, timeLeft: 5 });
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            planetGroup.rotation.y += rotationSpeed;
            if (spacecraft) {
                let direction = new THREE.Vector3().subVectors(new THREE.Vector3(0, 0, 0), spacecraft.position).normalize();
                let gravityForce = direction.multiplyScalar(gravityStrength);
                velocity.add(gravityForce);
                spacecraft.position.add(velocity);
                if (cameraLockedToSpacecraft) {
                    camera.position.copy(spacecraft.position).add(new THREE.Vector3(0, 10, 5));
                    camera.lookAt(spacecraft.position);
                    spacecraft.rotation.x += 0.001;
                    spacecraft.rotation.y += 0.001;
                    spacecraft.rotation.z += 0.001;
                } else if (cameraLockedToPlanet) {
                    cameraLockedToSpacecraft = false;
                    if (planet) {
                        const planetWorldPos = new THREE.Vector3();
                        planet.getWorldPosition(planetWorldPos);
                        camera.position.copy(planetWorldPos).add(new THREE.Vector3(0, 10, 20));
                        camera.lookAt(planetWorldPos);
                    }
                } else {
                    if (camera.position.x !== 0 || camera.position.y !== 15 || camera.position.z !== 20) {
                        camera.position.set(0, 15, 20);
                        camera.lookAt(new THREE.Vector3(0, 0, 0));
                    }
                }
                checkCollision();
            }

            // Display informational text for spacecraft and planet camera locks
            const infoTextDiv = document.getElementById("infoText");
            const infoTextPlanetDiv = document.getElementById("infoTextPlanet");
            if (cameraLockedToSpacecraft) {
                infoTextDiv.style.display = "block";
            } else {
                infoTextDiv.style.display = "none";
            }
            if (cameraLockedToPlanet) {
                infoTextPlanetDiv.style.display = "block";
            } else {
                infoTextPlanetDiv.style.display = "none";
            }

            const collisionThreshold = 0.5;
            for (let i = geyserParticles.length - 1; i >= 0; i--) {
                const particle = geyserParticles[i];
                const particleWorldPos = new THREE.Vector3();
                particle.mesh.getWorldPosition(particleWorldPos);
                if (spacecraft && spacecraft.position.distanceTo(particleWorldPos) < collisionThreshold) {
                    geyserCollisionCount++;
                    collisionCounterDiv.innerText = "Particles Collected: " + geyserCollisionCount;
                    particle.geyserGroup.remove(particle.mesh);
                    geyserParticles.splice(i, 1);
                }
            }

            if (Math.random() < 0.05) {
                scheduleGeyser();
            }

            for (let i = upcomingGeysers.length - 1; i >= 0; i--) {
                upcomingGeysers[i].timeLeft -= delta;
                if (upcomingGeysers[i].timeLeft <= 0) {
                    planetGroup.remove(upcomingGeysers[i].marker);
                    createGeyserParticle(upcomingGeysers[i].surfacePoint);
                    upcomingGeysers.splice(i, 1);
                } else if (upcomingGeysers[i].timeLeft <= 5) {
                    upcomingGeysers[i].marker.material.color.set(0xff0000);
                }
            }

            for (let i = geyserParticles.length - 1; i >= 0; i--) {
                const particle = geyserParticles[i];
                particle.mesh.position.add(particle.velocity);
                particle.lifetime--;
                if (particle.lifetime <= 0) {
                    particle.geyserGroup.remove(particle.mesh);
                    geyserParticles.splice(i, 1);
                }
            }
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener("keydown", (event) => {
            if (event.key === "w") velocity.z -= 0.05;
            if (event.key === "s") velocity.z += 0.05;
            if (event.key === "a") velocity.x -= 0.05;
            if (event.key === "d") velocity.x += 0.05;
            if (event.key === "q") velocity.y -= 0.05;
            if (event.key === "e") velocity.y += 0.05;
            if (!cameraLockedToSpacecraft) {
                camera.lookAt(new THREE.Vector3(0, 0, 0));
            }
        });
    </script>
</body>
</html>
